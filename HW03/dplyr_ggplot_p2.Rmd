---
title: 'Assignment 03: dplyr/ggplot2 Part II'
output: html_document
---

```{r}
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(gapminder))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(scales))
```


Pick three of the six tasks below, and produce:

    a tibble, using dplyr as your data manipulation tool;
    an accompanying plot of data from the tibble, using ggplot2 as your visualization tool; and
    some dialogue about what your tables/figures show (doesnâ€™t have to be much).



## Task Option 2

*Get the maximum and minimum of GDP per capita for all continents.*

This question seems a bit ambiguous. Here are some different interpretations I came up with, and the solutions to each:

- Maximum and minimum gdpPercap values in Gapminder across all continents
  - So here, we would only be looking for two numbers... the maximum and minimum gdpPercap entries in the whole dataframe.
  
```{r}
gapminder %>% 
  summarize(max_gdp = max(gdpPercap), min_gdp = min(gdpPercap)) %>% 
  kable()
```

- This version shows the Gapminder entries that contained the maximum or minimum GDP per capita **of all time** (at least within the limits of the dataframe) for that continent, including the country and year that it occurred.

```{r}
per_cont <- gapminder %>% 
  group_by(continent) %>% 
  filter(gdpPercap==min(gdpPercap) | gdpPercap==max(gdpPercap)) %>% 
  mutate(type=if_else(gdpPercap==max(gdpPercap), paste("max"), paste("min")))
kable(per_cont)
```

  - Here's a bar graph edition. I tried using a logarithmic y axis scale, but the max and min bars became too close together and made it difficult to make a proper comparison.
  
```{r}
per_cont %>% 
  group_by(continent, type) %>% 
  ggplot(aes(x=continent, y=gdpPercap))+geom_bar(stat="identity", aes(fill=type), position=position_dodge2())
```

- We can also take the task request to mean the maximum and minimum GDP per capita of each continent *for a given year*. This way, we're eliminating time as a confounding factor.

```{r}
per_cont_year <- gapminder %>% 
  group_by(continent, year) %>% 
  filter(gdpPercap==min(gdpPercap) | gdpPercap==max(gdpPercap)) %>% 
  mutate(type=if_else(gdpPercap==max(gdpPercap), paste("max"), paste("min")))
datatable(per_cont_year)
per_cont_year %>% 
  group_by(continent, type) %>% 
  arrange(year) %>% 
  ggplot(aes(x=continent, y=gdpPercap))+geom_bar(stat="identity", aes(fill=type), position=position_dodge2())
```

  - This grouped bar graph tries to cram the data from all 12 of the years included in the dataframe into one graph by breaking up each solid bar, first into min GDP and max GDP types, then into several more tiny bars to represent each year. It's a little wacky, but it more or less gets the point across. 
  - We can infer that Asia has experienced massive fluctuations in its maximum GDP per capita, while maximum GDP per capita has been steadily on the rise in Europe, the Americas, and Oceania.
  
  - Alternatively, let's present the difference between maximum and minimum GDP per capita over the years:
  
```{r}
per_cont_year %>% 
  group_by(continent, year) %>% 
  arrange(continent, year, desc(type)) %>% 
  mutate(diff=gdpPercap-lag(gdpPercap)) %>% 
  drop_na() %>% 
  ggplot(aes(x=year, y=diff, color=continent))+geom_line()
```
  
  - Here, we can see that Oceania has consistently had the lowest difference between minimum and maximim GDP per capita (having taken a peek at the tabular data, I can report that the lowest point is actually only a 2-digit difference, in 1967). Overall, the difference has been on the rise (excluding Asia's wild fluctuations).



## Task Option 4

*Compute a trimmed mean of life expectancy for different years. Or a weighted mean, weighting by population. Just try something other than the plain vanilla mean.*

Here is a plot of mean global life expectancy over the years, weighted by global population:

```{r}
gapminder %>% 
  group_by(year) %>% 
  summarize(avg_lifeExp=weighted.mean(lifeExp, pop)) %>% 
  ggplot(aes(x=year, y=avg_lifeExp))+geom_line()
```

In contrast, here is a plot of mean global life expectancy weighted by country:

```{r}
gapminder %>% 
  group_by(year) %>% 
  summarize(avg_lifeExp_c=mean(lifeExp)) %>% 
  ggplot(aes(x=year, y=avg_lifeExp_c))+geom_line()
```

We can see that the 'kink' around the early 1960s that was present on the first plot has now been smoothed out. This suggests that one or multiple low life expectancy countries had a population boom (or drop in life expectancy) around that time. 

Let's further group our data by continent to track down that country/those countries:

```{r}
gapminder %>% 
  group_by(year, continent) %>% 
  summarize(avg_lifeExp=weighted.mean(lifeExp, pop)) %>% 
  ggplot(aes(x=year, y=avg_lifeExp, color=continent))+geom_line()
```

Now we know that it's some Asian country/countries where this occurred. Read on to the next task, where we will continue our investigative work to speculate what may have happened!



## Task Option 6

*Find countries with interesting stories. Open-ended and, therefore, hard. Promising but unsuccessful attempts are encouraged. This will generate interesting questions to follow up on in class.*

Let's return to the plot from Task 4, where we found that the average life expectancy (weighted by population) stagnated around 1960 for Asia, suggesting a population boom and/or drop in life expectancy. The goal in this task will be to pinpoint the country or countries involved, and compare the data we unearth to historical events to see how well our conclusions hold up.

First off, the number of countries in Asia:

```{r}
gapminder %>% 
  filter(continent=="Asia") %>% 
  group_by(year) %>% 
  count() %>% 
  kable()
```

33 is too many to comfortably fit onto one plot. Rather than trying to assess the data visually in one go (as we could do for continents, since there's only 6 of those), we're better off doing some additional wrangling.

```{r}
pop_growth <- gapminder %>% 
  filter(continent=="Asia" & year %in% c(1952, 1957, 1962, 1967)) %>% 
  group_by(country) %>% 
  arrange(country, year) %>% 
  mutate(growth=pop-lag(pop)) %>% 
  drop_na() %>% #I TRIED TO GROUP_BY() AND SUMMARIZE() AFTER THIS AND ALL THE NON-ASIAN COUNTRIES CAME BACK???

  arrange(desc(growth)) 
pop_growth %>% 
  select(country, year, pop, growth) %>% 
  datatable()
```

Aha! Here we see that China and India led the board in population growth between 1955-1965. Here are the life expectancy plots for the two countries:

```{r}
pop_growth %>%
  filter(country %in% c("China", "India")) %>% 
  ggplot(aes(x=year, y=lifeExp))+geom_line(aes(color=country))
```
The life expectancy for India increases, but China's actually decreases. It seems China is the country that warped the global trendline. In fact, here's the global data again, but without it:

```{r}
gapminder %>% 
  filter(country != "China") %>% 
  group_by(year) %>% 
  summarize(avg_lifeExp=weighted.mean(lifeExp, pop)) %>% 
  ggplot(aes(x=year, y=avg_lifeExp))+geom_line()
```

Let's take a look at the spread of population growth over those years:

```{r}
pop_growth %>% 
  ggplot(aes(x=growth, fill=country=="China"))+
  geom_histogram(bins=50)+scale_x_continuous(labels=comma_format())
```

Normalized to percentage growth:

```{r}
pop_growth %>% 
  mutate(percent=pop/(pop-growth)) %>% 
  ggplot(aes(x=percent, fill=country=="China"))+
  geom_histogram(bins=50)+scale_x_continuous(labels=comma_format())
```

Here we can see the population growth was actually fairly normal for a population of that size. Maybe even a little low.

How does China's percent population growth and life expectancy look over the span of Gapminder's data?

```{r}
china_data <- gapminder %>% 
  filter(country=="China") %>% 
  arrange(year) %>% 
  mutate(growth=pop-lag(pop), percent=pop/(pop-growth)) %>% 
  drop_na()
china_data %>% 
  ggplot(aes(x=percent,y=lifeExp,color=year))+geom_path()+geom_point(size=2)
```

It seems something drastic occurred between 1957 and 1962, and a second, less impactful event about a decade later. I already have a strong suspicion what happened during that time period, but let's continue our data exploration and see what else we can unearth.

How did China's life expectancy change compared to other Asian countries during this time period?

```{r}
pop_growth %>% 
  ggplot(aes(x=year, y=lifeExp, group=country, color=country=="China"))+geom_line(alpha=0.5, size=1.5)
```

While other countries exhibited a steady increase in life expectancy, China's actually dropped in the early 1960s. 

Finally, let's look at GDP per capita:

```{r}
pop_growth %>% 
  mutate(percent=pop/(pop-growth)) %>% 
  ggplot(aes(x=percent,y=gdpPercap, color=country=="China"))+
  geom_point()+scale_x_log10()+scale_y_log10()

pop_growth %>% 
  ggplot(aes(x=gdpPercap,y=lifeExp, color=country=="China"))+geom_point()+scale_x_log10()

#MAYBE RETIRE THE ABOVE PLOTS 'CAUSE THEY DON'T ADD NUTHIN' MUCH

china_data %>% 
  ggplot(aes(x=gdpPercap,y=lifeExp, color=year))+geom_path()+scale_x_log10()+scale_y_log10()+geom_point(size=2)

china_data %>% 
  ggplot(aes(x=percent,y=gdpPercap, color=year))+geom_path()+scale_y_log10()+geom_point(size=2)

```

Check out that drop in GDP per capita AND life expectancy. Whew.

Let's amass all our clues for what occurred between 1957-1967:

- Decrease in percentage population growth trend;
- Decrease in life expectancy;
- Decrease in GDP per capita.

So what was the event I was alluding to? I believe these trends were caused by the [Great Leap Forward](https://en.wikipedia.org/wiki/Great_Leap_Forward) (1958-1962). This was a movement to convert China's then agrarian economy to socialism, which backfired with devastating results for the populace ( [Great Chinese Famine](https://en.wikipedia.org/wiki/Great_Chinese_Famine)). 


What else happened in China's history from 1952 to 2007? There's another dip in percent population growth between 1972-1982. At the same time, we can see a steep increase in GDP per capita starting around 1972. This can be explained by the [Chinese economic reform](https://en.wikipedia.org/wiki/Chinese_economic_reform) starting in the late 1970s and the start of [population control](https://en.wikipedia.org/wiki/One-child_policy). Meanwhile, with the horrors of the [Cultural Revolution](https://en.wikipedia.org/wiki/Cultural_Revolution) behind them (and also assuming advances in modern medicine), the life expectancy increased over the years.

It's pretty amazing that the fallout of one country's history is visible on a global scale! Just how does China's population compare to the rest of the world's?

```{r}
gapminder %>% 
  filter(year==1957) %>% 
  group_by(country=="China") %>% 
  ggplot(aes(x="", y=pop, fill=country=="China"))+geom_bar(stat="identity")+coord_polar("y", start=0)
```

In 1957, China constituted nearly a quarter of the world population.

